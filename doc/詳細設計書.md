# ポケカサーチ 詳細設計書

作成日: 2025-08-10

## 1. システムアーキテクチャ図

```mermaid
graph TB
    subgraph "Frontend (Vercel Edge)"
        A[Next.js App Router<br/>TypeScript/TailwindCSS]
        B[SSR/ISR Pages]
        C[API Routes]
    end
    
    subgraph "External Services"
        D[Vercel Analytics]
        E[Google Analytics]
        F[SendGrid<br/>Email]
        G[LINE<br/>Messaging API]
        H[Contentful/Sanity<br/>CMS]
    end
    
    subgraph "Data Layer"
        I[PostgreSQL<br/>Vercel Postgres/Supabase]
        J[Vercel KV<br/>Redis Cache]
        K[Upstash/QStash<br/>Job Queue]
    end
    
    subgraph "Workers/Jobs"
        L[Price Ingestor<br/>Worker]
        M[Aggregator<br/>Worker]
        N[Ranker<br/>Worker]
        O[Alert<br/>Worker]
    end
    
    subgraph "External Data Sources"
        P[Shop APIs]
        Q[Shop HTML<br/>Pages]
        R[Marketplace<br/>Data]
    end
    
    A --> B
    A --> C
    B --> I
    C --> I
    C --> J
    
    L --> P
    L --> Q
    L --> R
    L --> I
    
    M --> I
    N --> I
    O --> I
    O --> F
    O --> G
    
    K --> L
    K --> M
    K --> N
    K --> O
    
    A --> D
    A --> E
    B --> H
    C --> J
```

## 2. ER図

```mermaid
erDiagram
    shops {
        int id PK
        text name
        text url
        boolean is_verified
        text affiliate_program
        text affiliate_id
        jsonb shipping_policy
        jsonb return_policy
    }
    
    sets {
        text id PK
        text code UK
        text name_jp
        text name_en
        date release_date
        text image_url
    }
    
    cards {
        text id PK
        text set_id FK
        text number
        text name_jp
        text name_en
        text rarity
        text image_url
        date release_date
        timestamp created_at
    }
    
    card_prices {
        bigint id PK
        text card_id FK
        int shop_id FK
        text condition
        text grade_type
        text grade_value
        int price_jpy
        int shipping_jpy
        int stock_qty
        int eta_days
        text url
        timestamp collected_at
    }
    
    price_snapshots {
        bigint id PK
        text card_id FK
        timestamp ts
        int min_jpy
        int median_jpy
        int max_jpy
        int shop_count
    }
    
    users {
        uuid id PK
        text email UK
        text password_hash
        text line_uid
        timestamp created_at
    }
    
    favorites {
        uuid user_id FK
        text card_id FK
        timestamp created_at
    }
    
    alerts {
        uuid id PK
        uuid user_id FK
        text card_id FK
        int threshold_jpy
        text direction
        text channel
        boolean is_active
    }
    
    blog_posts {
        uuid id PK
        text slug UK
        text title
        text excerpt
        text body
        uuid author_id FK
        timestamp published_at
        text[] tags
    }
    
    rankings {
        bigint id PK
        text card_id FK
        text type
        float delta_percent_24h
        float delta_percent_7d
        int rank
        timestamp updated_at
    }
    
    sets ||--o{ cards : contains
    cards ||--o{ card_prices : has
    shops ||--o{ card_prices : sells
    cards ||--o{ price_snapshots : tracked
    users ||--o{ favorites : has
    users ||--o{ alerts : creates
    cards ||--o{ favorites : favorited
    cards ||--o{ alerts : monitored
    users ||--o{ blog_posts : writes
    cards ||--o{ rankings : ranked
```

## 3. データフロー図

```mermaid
flowchart TB
    subgraph "External Sources"
        A1[Shop APIs]
        A2[Shop HTML Pages]
        A3[Marketplace Data]
    end
    
    subgraph "Ingestion Layer"
        B1[Price Ingestor Worker<br/>20-40min intervals]
        B2[API Parser]
        B3[HTML Scraper]
        B4[Data Normalizer]
    end
    
    subgraph "Storage Layer"
        C1[(card_prices<br/>Raw Price Data)]
        C2[(price_snapshots<br/>Hourly Aggregates)]
        C3[(rankings<br/>Calculated Rankings)]
        C4[Vercel KV<br/>Cache Layer]
    end
    
    subgraph "Processing Layer"
        D1[Aggregator Worker<br/>Hourly]
        D2[Ranker Worker<br/>3x Daily]
        D3[Alert Worker<br/>Every 5min]
    end
    
    subgraph "API Layer"
        E1[Next.js API Routes]
        E2[GraphQL/REST Endpoints]
    end
    
    subgraph "Presentation Layer"
        F1[SSR Pages]
        F2[ISR Pages<br/>10-60min revalidation]
        F3[Client Components]
    end
    
    subgraph "Notification Services"
        G1[SendGrid<br/>Email Service]
        G2[LINE<br/>Messaging API]
    end
    
    A1 --> B2
    A2 --> B3
    A3 --> B3
    B2 --> B4
    B3 --> B4
    B1 --> B2
    B1 --> B3
    
    B4 --> C1
    
    D1 --> C1
    D1 --> C2
    
    D2 --> C2
    D2 --> C3
    
    D3 --> C1
    D3 --> G1
    D3 --> G2
    
    E1 --> C1
    E1 --> C2
    E1 --> C3
    E1 --> C4
    
    C1 --> C4
    C2 --> C4
    C3 --> C4
    
    E1 --> F1
    E1 --> F2
    F2 --> F3
    
    style B1 fill:#f9f,stroke:#333,stroke-width:2px
    style D1 fill:#bbf,stroke:#333,stroke-width:2px
    style D2 fill:#bbf,stroke:#333,stroke-width:2px
    style D3 fill:#bbf,stroke:#333,stroke-width:2px
```

## 4. シーケンス図（価格取得〜表示）

```mermaid
sequenceDiagram
    participant User
    participant Browser
    participant NextJS
    participant APIRoute
    participant VercelKV
    participant PostgreSQL
    participant Ingestor
    participant ShopAPI
    
    Note over Ingestor,ShopAPI: 価格取得プロセス（20-40分間隔）
    Ingestor->>ShopAPI: GET /products/{id}
    ShopAPI-->>Ingestor: 価格・在庫データ
    Ingestor->>Ingestor: データ正規化処理
    Ingestor->>PostgreSQL: UPSERT card_prices
    
    Note over User,PostgreSQL: ユーザーアクセス時
    User->>Browser: カード詳細ページアクセス
    Browser->>NextJS: GET /cards/{setId}/{cardId}
    NextJS->>APIRoute: getCardDetails({cardId})
    
    APIRoute->>VercelKV: キャッシュ確認
    alt キャッシュヒット
        VercelKV-->>APIRoute: キャッシュデータ
    else キャッシュミス
        APIRoute->>PostgreSQL: SELECT card_prices
        PostgreSQL-->>APIRoute: 価格データ
        APIRoute->>PostgreSQL: SELECT price_snapshots
        PostgreSQL-->>APIRoute: 統計データ
        APIRoute->>APIRoute: 総コスト計算
        APIRoute->>VercelKV: キャッシュ保存(TTL:10min)
    end
    
    APIRoute-->>NextJS: 価格比較データ
    NextJS->>NextJS: SSR/ISRレンダリング
    NextJS-->>Browser: HTMLレスポンス
    Browser-->>User: 価格比較表示
```

## 5. シーケンス図（アラート通知）

```mermaid
sequenceDiagram
    participant AlertWorker
    participant QStash
    participant PostgreSQL
    participant VercelKV
    participant SendGrid
    participant LINE
    participant User
    
    Note over AlertWorker,QStash: 5分間隔で実行
    QStash->>AlertWorker: トリガー実行
    AlertWorker->>PostgreSQL: SELECT active alerts
    PostgreSQL-->>AlertWorker: アクティブアラート一覧
    
    loop 各アラートをチェック
        AlertWorker->>PostgreSQL: SELECT latest price
        PostgreSQL-->>AlertWorker: 現在価格
        
        alt 閾値条件を満たす
            AlertWorker->>VercelKV: 重複送信チェック
            VercelKV-->>AlertWorker: 送信履歴
            
            alt 未送信
                AlertWorker->>AlertWorker: 通知データ生成
                
                alt メール通知
                    AlertWorker->>SendGrid: Send Email API
                    SendGrid-->>AlertWorker: 送信完了
                    SendGrid->>User: アラートメール
                else LINE通知
                    AlertWorker->>LINE: Push Message API
                    LINE-->>AlertWorker: 送信完了
                    LINE->>User: プッシュ通知
                end
                
                AlertWorker->>VercelKV: 送信履歴記録(TTL:24h)
                AlertWorker->>PostgreSQL: UPDATE alert status
            end
        end
    end
    
    AlertWorker->>QStash: 処理完了
```

## 6. クラス図（主要コンポーネント）

```mermaid
classDiagram
    class Card {
        +string id
        +string setId
        +string number
        +string nameJp
        +string nameEn
        +string rarity
        +string imageUrl
        +Date releaseDate
        +getPrices()
        +getSnapshot()
        +getRelatedCards()
    }
    
    class PriceService {
        -DatabaseClient db
        -CacheClient cache
        +getCardPrices(cardId)
        +calculateTotalCost(price, shipping)
        +getPriceHistory(cardId, days)
        +comparePrices(cardId)
    }
    
    class Shop {
        +number id
        +string name
        +string url
        +boolean isVerified
        +string affiliateId
        +ShippingPolicy shippingPolicy
        +getShippingCost(prefecture)
        +generateAffiliateLink(cardId)
    }
    
    class PriceIngestor {
        -APIClient apiClient
        -HTMLParser parser
        -DataNormalizer normalizer
        +fetchPrices(shopId)
        +parsePriceData(rawData)
        +savePrices(normalizedData)
    }
    
    class AlertManager {
        -NotificationService notifier
        -DatabaseClient db
        +checkAlerts()
        +sendNotification(alert, price)
        +recordNotification(alertId)
    }
    
    class NotificationService {
        -EmailClient emailClient
        -LineClient lineClient
        +sendEmail(user, message)
        +sendLine(user, message)
    }
    
    class CacheManager {
        -RedisClient redis
        +get(key)
        +set(key, value, ttl)
        +invalidate(pattern)
    }
    
    class RankingService {
        -DatabaseClient db
        +calculateRankings(type)
        +getDeltaPercent(cardId, period)
        +updateRankings()
    }
    
    class AuthService {
        +login(email, password)
        +loginWithLine(code)
        +generateToken(userId)
        +validateToken(token)
    }
    
    class User {
        +string id
        +string email
        +string lineUid
        +Date createdAt
        +addFavorite(cardId)
        +removeFavorite(cardId)
        +createAlert(cardId, threshold)
    }
    
    Card "1" --> "*" PriceService : uses
    PriceService --> Shop : queries
    PriceService --> CacheManager : uses
    PriceIngestor --> Shop : fetches from
    AlertManager --> NotificationService : uses
    AlertManager --> User : notifies
    RankingService --> Card : ranks
    AuthService --> User : authenticates
    User --> Card : favorites
```

## 7. コンポーネント構成図

```mermaid
graph TB
    subgraph "Pages (App Router)"
        P1[app/page.tsx<br/>ホームページ]
        P2[app/cards/[setId]/[cardId]/page.tsx<br/>カード詳細]
        P3[app/search/page.tsx<br/>検索結果]
        P4[app/rankings/[type]/page.tsx<br/>ランキング]
        P5[app/sets/[setId]/page.tsx<br/>新弾LP]
        P6[app/blog/page.tsx<br/>ブログ一覧]
        P7[app/mypage/page.tsx<br/>マイページ]
    end
    
    subgraph "UI Components"
        C1[PriceTable<br/>価格比較テーブル]
        C2[PriceBadge<br/>総コスト表示]
        C3[ShopTrustBadge<br/>信頼マーク]
        C4[PriceChart<br/>価格推移グラフ]
        C5[CardTile<br/>カードタイル]
        C6[SearchBar<br/>検索バー]
        C7[FilterPanel<br/>フィルタパネル]
        C8[FavoriteButton<br/>お気に入りボタン]
        C9[AlertModal<br/>アラート設定]
    end
    
    subgraph "API Routes"
        A1[api/cards/route.ts<br/>カード検索API]
        A2[api/cards/[id]/route.ts<br/>カード詳細API]
        A3[api/rankings/route.ts<br/>ランキングAPI]
        A4[api/favorites/route.ts<br/>お気に入りAPI]
        A5[api/alerts/route.ts<br/>アラートAPI]
        A6[api/auth/route.ts<br/>認証API]
    end
    
    P1 --> C5
    P1 --> C6
    P2 --> C1
    P2 --> C2
    P2 --> C3
    P2 --> C4
    P2 --> C8
    P2 --> C9
    P3 --> C5
    P3 --> C7
    P4 --> C5
    
    P1 --> A3
    P2 --> A2
    P3 --> A1
    P7 --> A4
    P7 --> A5
```

## 8. 状態遷移図（アラート）

```mermaid
stateDiagram-v2
    [*] --> Created: ユーザーがアラート作成
    Created --> Active: 有効化
    Active --> Triggered: 閾値条件を満たす
    Triggered --> Notified: 通知送信成功
    Triggered --> Failed: 通知送信失敗
    Failed --> Active: リトライ成功
    Notified --> Cooldown: クールダウン期間
    Cooldown --> Active: 24時間経過
    Active --> Paused: ユーザーが一時停止
    Paused --> Active: ユーザーが再開
    Active --> Deleted: ユーザーが削除
    Paused --> Deleted: ユーザーが削除
    Deleted --> [*]
```

## 9. デプロイメントアーキテクチャ

```mermaid
graph LR
    subgraph "Development"
        D1[Local Next.js]
        D2[Local PostgreSQL]
        D3[Local Redis]
    end
    
    subgraph "Staging (Vercel Preview)"
        S1[Preview Deployment]
        S2[Staging DB]
        S3[Staging KV]
    end
    
    subgraph "Production (Vercel)"
        subgraph "Edge Network"
            P1[Edge Functions<br/>Global]
            P2[Static Assets<br/>CDN]
        end
        
        subgraph "Serverless"
            P3[API Routes<br/>us-west-1]
            P4[Background Jobs<br/>us-west-1]
        end
        
        subgraph "Data Services"
            P5[PostgreSQL<br/>Primary]
            P6[PostgreSQL<br/>Read Replica]
            P7[Vercel KV<br/>Redis]
        end
    end
    
    D1 --> S1
    S1 --> P1
    P1 --> P3
    P3 --> P5
    P3 --> P7
    P4 --> P5
    P4 --> P7
    P5 --> P6
```