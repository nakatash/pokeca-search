# ポケカサーチ 仕様書 v1（0〜12か月）

作成日: 2025-08-10
対象期間: ローンチ〜12か月
開発: Next.js(App Router) + TypeScript / Vercel(Edge/Serverless)
略記: 本書では“ポケカサーチ”=本サイト

---

## 0. 目的・ゴール

**目的**: ポケモンカードの価格情報を“鑑定済みショップ＋主要EC”で横断比較し、ユーザーの購入・売却意思決定を支援する。
**12か月時点のゴール**:

* 月間PV 24万、検索流入60%+
* 主要機能: 価格比較/カード単体ページ/ランキング/ブログ・ニュース/新弾LP/お気に入り/価格アラート(メール・LINE)/PSA/BGSランク別比較
* 収益: 広告 + アフィリエイト（提携先ショップへの送客）

**非ゴール（13か月以降へ委譲）**: ポートフォリオ管理、損益計算、有料プラン、英語版全面展開

---

## 1. プロダクト要件

### 1.1 ペルソナ

* **購入派（投機/転売含む）**: 高騰前の買いを狙う。価格推移と在庫・送料まで含む“総コスト”比較を重視。
* **コレクター**: PSA/BGSなど鑑定ランク別の相場を重視。保存用/観賞用を複数購入する。
* **カジュアル層**: “いまの相場”を手早く知りたい。ランキング・新弾の当たりカードに関心。

### 1.2 主要ユースケース

* カード名/型番で検索→最安値・在庫・送料・配送目安を比較
* 相場推移チャートで高騰/下落を把握
* 新弾ページで“当たり”候補や初動相場を確認
* 気になるカードをお気に入り登録→閾値到達でメール/LINE通知
* PSA/BGS別価格のレンジ把握

---

## 2. 機能要件（0〜12か月で提供）

### 2.1 Phase1（0〜3か月）

1. **価格比較（鑑定済みショップ＋主要EC）**

* ショップ一覧（例）: 晴れる屋、駿河屋、カードラッシュ、まんぞく屋、その他“鑑定済み/信頼済みショップ”
* 価格・在庫・送料・配送目安を正規化し“総コスト”で比較
* アフィリエイトID/UTMをリンクに自動付与

2. **カード単体ページ自動生成**

* 入力: カードID（セット/型番）、名称、レアリティ、画像
* 出力: /cards/{setId}/{cardId}
* 含有: 現在価格、最安/中央値/最高、過去n日チャート、関連カード、メタ情報（OGP/構造化データ）

3. **ランキング自動化（高騰/下落/在庫減少）**

* 更新頻度: 1日3回
* 指標: Δ%（24h/7d）、出来高 proxy（価格更新回数×ショップ数）

4. **ブログ/ニュース**

* CMS（Headless）: Contentful or Sanity
* 記事タイプ: 新弾速報、相場解説、買取比較、イベント速報

### 2.2 Phase2（4〜12か月）

5. **価格アラート（メール/LINE）**

* ユーザーが閾値（≤ or ≥ 価格）を設定
* ジョブキューで判定→通知

6. **お気に入りカード機能**

* ログイン必須。カード詳細/一覧からトグル保存
* ダッシュボードで価格変動を一覧

7. **PSA/BGSランク別価格比較**

* ランク: PSA 6〜10/BGS 9〜10/Black Label
* ランク別の最安/中央値、チャート

8. **新弾特設LP（自動生成）**

* /sets/{setId}
* 収録カード一覧、当たりランキング、発売日前後の初動チャート

---

## 3. データ要件

### 3.1 取得対象と方式

* **ショップAPI/HTML**: 各ショップの公開情報を、利用規約とrobots.txtを尊重しつつ取得。APIがない場合は**同意を得た上で**HTMLパーシング。
* **フリマ/オークション**: 12か月時点では“参考指標”として価格レンジを使用（詳細連動は法務確認後）。

### 3.2 正規化スキーマ（抜粋）

* **shops**(id, name, url, is\_verified, affiliate\_program, affiliate\_id, shipping\_policy, return\_policy)
* **cards**(id, set\_id, number, name\_jp, name\_en, rarity, image\_url, release\_date, created\_at)
* **card\_prices**(id, card\_id, shop\_id, condition, grade\_type, grade\_value, price\_jpy, shipping\_jpy, stock\_qty, eta\_days, url, collected\_at)
* **price\_snapshots**(id, card\_id, ts, min\_jpy, median\_jpy, max\_jpy, shop\_count)
* **user**(id, email, line\_uid, hashed\_pw, created\_at)
* **favorites**(user\_id, card\_id, created\_at)
* **alerts**(id, user\_id, card\_id, threshold\_jpy, direction(enum: up/down), channel(enum: email/line), is\_active)
* **sets**(id, code, name\_jp, name\_en, release\_date, image\_url)
* **blog\_posts**(id, slug, title, excerpt, body, author\_id, published\_at, tags)

### 3.3 価格正規化・“総コスト”式

```
総コスト = 本体価格 + 送料(地域/条件別) + 手数料(必要なら)
表示優先: 総コスト昇順、次に在庫数降順、次に配送日数昇順
```

### 3.4 更新頻度

* 価格クロール: 20〜40分間隔（ショップごとにスロットリング）
* スナップショット集計: 1時間毎
* ランキング更新: 8時/14時/22時

---

## 4. アーキテクチャ

### 4.1 技術スタック

* **フロント**: Next.js (App Router) + TypeScript + TailwindCSS
* **ホスティング**: Vercel（Edge Functions/Serverless Functions）
* **DB**: PostgreSQL（Vercel Postgres or Supabase）
* **キャッシュ**: Vercel KV (Redis系)
* **キュー/ジョブ**: Upstash/QStash
* **通知**: SendGrid(メール)、LINE Messaging API
* **分析**: Vercel Analytics + Gtag
* **CMS**: Contentful / Sanity（どちらか）

### 4.2 データフロー（簡易）

1. Ingestor(Worker)がショップのAPI/HTMLを取得→正規化→`card_prices`にUPSERT
2. Aggregator(Worker)が1時間ごとに`price_snapshots`へ集計
3. RankerがΔ%を計算→ランキングテーブル更新
4. API(Route Handlers)がSSR/ISRでページへ提供
5. Alert Workerが`alerts`をスキャン→閾値到達→送信

### 4.3 API設計（抜粋）

* `GET /api/cards?query=ピカチュウ&set=SV3a&limit=20`

  * Res: {cards:\[{id,name,number,set,rarity,image\_url}]}
* `GET /api/cards/{id}`

  * Res: {card, prices:\[{shop,total\_price,price,shipping,stock,eta,url}], snapshot:{min,median,max}, related:\[]}
* `GET /api/rankings?type=spike_24h`
* `POST /api/favorites` (auth)
* `POST /api/alerts` (auth)

### 4.4 認証/認可

* Email+Password / LINE Login
* JWT(Access) + HttpOnly Cookie(Refresh)
* レート制限: 60 req/min/IP（KVでトークンバケット）

---

## 5. 画面要件（主要ページ）

* **ホーム**: トップランキング、検索、注目の新弾、最新記事
* **検索結果**: フィルタ（価格帯/在庫有/送料込み/配送日数/鑑定ランク）
* **カード詳細**: 価格比較テーブル、相場チャート、ショップ信頼マーク、関連カード、お気に入り/アラートボタン
* **ランキング**: 高騰/下落/在庫減少
* **新弾LP**: 収録一覧、当たりランキング、初動グラフ
* **ブログ**: 記事一覧/詳細（構造化データ: Article）
* **マイページ**: お気に入り一覧、アラート管理

**コンポーネント（抜粋）**: PriceTable, PriceBadge(総コスト), ShopTrustBadge, Chart(TimeSeries), CardTile, SetHeader, AlertModal, FavoriteButton

---

## 6. SEO/パフォーマンス要件

* **SSR + ISR**: カード詳細・セットLPはISR(再検証 10〜60分)
* **sitemap.xml**: `/cards/*`・`/sets/*`・`/blog/*` を分割出力（10万URL単位）
* **構造化データ**: `Product`(offers/AggregateOffer), `BreadcrumbList`, 記事は`Article`
* **メタ**: title/description最適化（カード名/型番/レア/相場/最安）
* **OGP**: カード画像/セット画像を自動生成（OG Image Generation）
* **速度**: LCP < 2.5s, INP < 200ms（携帯回線）
* **i18n**: v1はJPのみ（英語ラベルはスキーマに保持）

---

## 7. 収益化/アフィリエイト要件

* アフィID管理: `shops.affiliate_id` を参照しリンク生成
* **リンク安全策**: 外部リンクは中継`/out?sid=..&cid=..`で計測＋rel="sponsored nofollow"
* **広告**: レイアウトスロット準備（トップ、カード詳細上中下、記事中）

---

## 8. 品質/セキュリティ/法務

* **テスト**: ユニット（Jest）、E2E（Playwright）
* **監視**: Vercel Insights、Sentry
* **PII**: パスワードはArgon2、メールは暗号化保存、監査ログをKVへ
* **法務**: robots.txt/規約順守、スクレイピングは相手方の許可・API優先、利用規約/プライバシーポリシー設置
* **脆弱性**: SSRF/SQLi/XSS対策、CSP適用

---

## 9. スケジュール（マイルストーン）

* **M1（1か月目）**: 基盤（Next.js/Vercel/DB/KV/認証）・カードページ雛形・2ショップ連携
* **M2**: 価格比較テーブル/ランキング初版・ブログ導入・4ショップ連携
* **M3**: 新弾LP自動生成・画像OG/構造化データ・6ショップ連携
* **M4-6**: お気に入り/価格アラート(メール)・PSA/BGS比較β・8ショップ連携
* **M7-9**: LINE通知、ランキング強化、UI最適化、広告ABテスト
* **M10-12**: 性能/SEO最適化完了、アラート安定化、提携先拡大

---

## 10. 受け入れ基準（抜粋）

* **検索**: 「カード名 or 型番」入力時、300ms以内に候補10件を返す（KVキャッシュ）
* **カード詳細**: “総コスト”の計算が正しい（送料条件の差分テスト5ケース合格）
* **ランキング**: 24h/7dΔ%が再現性あり（同一データで再計算一致）
* **お気に入り**: 1,000カード登録でも<150msで初期描画
* **アラート**: 条件成立から5分以内に通知送信、二重送信なし
* **PSA/BGS**: ランク切替で価格テーブルとチャートが一致

---

## 11. 運用・ジョブ設計

* **Cron（Vercel/外部スケジューラ）**

  * `*/30 * * * *` 価格取得ワーカー（ショップごとにスロットリング）
  * `0 * * * *` スナップショット集計
  * `0 8,14,22 * * *` ランキング更新
  * `*/5 * * * *` アラート評価/送信
* **失敗時**: デッドレターキュー、再試行（指数バックオフ）、Sentry通知

---

## 12. 開発体制・ドキュメント

* Issue駆動/2週間スプリント/PRレビュー2名
* ADR（アーキ決定記録）運用
* README: セットアップ、環境変数、スキーマDDL、Seedデータ

---

## 13. 付録：DB DDL（概略）

```sql
CREATE TABLE shops (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  url TEXT NOT NULL,
  is_verified BOOLEAN DEFAULT false,
  affiliate_program TEXT,
  affiliate_id TEXT,
  shipping_policy JSONB,
  return_policy JSONB
);

CREATE TABLE sets (
  id TEXT PRIMARY KEY,
  code TEXT UNIQUE,
  name_jp TEXT,
  name_en TEXT,
  release_date DATE,
  image_url TEXT
);

CREATE TABLE cards (
  id TEXT PRIMARY KEY,
  set_id TEXT REFERENCES sets(id),
  number TEXT,
  name_jp TEXT,
  name_en TEXT,
  rarity TEXT,
  image_url TEXT,
  release_date DATE,
  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE card_prices (
  id BIGSERIAL PRIMARY KEY,
  card_id TEXT REFERENCES cards(id),
  shop_id INTEGER REFERENCES shops(id),
  condition TEXT,
  grade_type TEXT,
  grade_value TEXT,
  price_jpy INTEGER,
  shipping_jpy INTEGER,
  stock_qty INTEGER,
  eta_days INTEGER,
  url TEXT,
  collected_at TIMESTAMP
);

CREATE TABLE price_snapshots (
  id BIGSERIAL PRIMARY KEY,
  card_id TEXT REFERENCES cards(id),
  ts TIMESTAMP,
  min_jpy INTEGER,
  median_jpy INTEGER,
  max_jpy INTEGER,
  shop_count INTEGER
);

CREATE TABLE users (
  id UUID PRIMARY KEY,
  email TEXT UNIQUE,
  password_hash TEXT,
  line_uid TEXT,
  created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE favorites (
  user_id UUID REFERENCES users(id),
  card_id TEXT REFERENCES cards(id),
  created_at TIMESTAMP DEFAULT now(),
  PRIMARY KEY(user_id, card_id)
);

CREATE TABLE alerts (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  card_id TEXT REFERENCES cards(id),
  threshold_jpy INTEGER,
  direction TEXT CHECK(direction IN ('up','down')),
  channel TEXT CHECK(channel IN ('email','line')),
  is_active BOOLEAN DEFAULT true
);
```

---

## 14. 命名・URL規約

* カード詳細: `/cards/{setCode}/{cardNumber}-{slug}`
* セットLP: `/sets/{setCode}`
* ランキング: `/rankings/{type}` （type: spike-24h, drop-24h, low-stock 等）

---

## 15. リスク・対応

* **取得元の規約違反リスク**: 事前合意/提携を優先。利用停止に備えデータ源多重化。
* **価格の誤認**: 取得日時/ショップ名/条件を明示、ディスクレーマ掲載。
* **通知スパム**: 同一条件の重複通知抑止、1日上限/ユーザーを設定。

---

以上。0〜12か月の“作って伸ばす”ための実装・運用要件を網羅。必要に応じて、各APIのOpenAPI定義・ER図（Mermaid）・計測KPIダッシュボード定義を追補する。
